            <style>
                input[type=number]#trail-hours {
                    width:10ch;
                }
                select#sort-by {
                    width: 16ch;
                    min-width: 0;
                    max-width: 100%;
                    font-size: inherit;
                    font-family: inherit;
                    line-height: 1;
                    padding: 0 2px;
                    margin: 0;
                    box-sizing: content-box;
                }
                input[type=number]#trail-hours {
                    font-size: inherit;
                }
                                                /* No custom styles for trail-hours input; use browser defaults */
            </style>
<!DOCTYPE html>
<html>
<head>
    <title>{{ app_title }} (v{{ app_version }})</title>
    <!-- Cache busting: version {{ app_version }} -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; display: flex; height: 100vh; }
        #map { flex: 1; }
        #sidebar { width: 320px; background: #f5f5f5; overflow-y: auto; padding: 0; }
        .node { padding: 8px; margin: 5px 8px; background: white; cursor: pointer; border-radius: 3px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .node.gray { color: #555; background: #f0f0f0; }
        .node.moved-alert { background-color: #ffcdd2; }  /* Darker light red background for moved nodes */
        .node-name { font-weight: bold; font-size: 0.95em; }
        .node-info { font-size: 0.8em; color: #666; margin-top: 3px; line-height: 1.4; }
        
        /* Custom tooltip styles for Safari compatibility */
        .tooltip-item { 
            position: relative; 
            display: inline-block;
            cursor: help;
            border-bottom: 1px dotted #999;
        }
        .tooltip-item:hover { 
            border-bottom-color: #666; 
        }
        .tooltip-item .tooltip-balloon {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 0;
            background-color: rgba(0, 0, 0, 0.9);
            color: #fff;
            text-align: left;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            transition: opacity 0.2s, visibility 0.2s;
            pointer-events: none;
        }
        .tooltip-item .tooltip-balloon::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 15px;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.9) transparent transparent transparent;
        }
        .tooltip-item:hover .tooltip-balloon {
            visibility: visible;
            opacity: 1;
        }
        
        .node-extra { font-size: 0.75em; color: #888; margin-top: 2px; padding-top: 3px; border-top: 1px solid #eee; }
        
        #status-bar { padding: 8px 10px; background: #1976D2; color: white; display: flex; justify-content: space-between; align-items: center; }
        #status-bar strong { font-size: 0.9em; }
        #menu-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 3px 8px; cursor: pointer; border-radius: 3px; font-size: 0.75em; }
        #menu-btn:hover { background: rgba(255,255,255,0.3); }
        
        /* Modal popup styles */
        #menu-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        #menu-modal.open { display: flex; align-items: center; justify-content: center; }
        #menu-panel { background: white; border-radius: 8px; padding: 20px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3); position: relative; }
        #menu-close { position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; color: #aaa; cursor: pointer; line-height: 20px; }
        #menu-close:hover { color: #000; }
        #menu-title { font-size: 1.3em; font-weight: bold; color: #1976D2; margin: 0 0 15px 0; padding-bottom: 10px; border-bottom: 2px solid #1976D2; }
        
        .menu-section { margin-bottom: 12px; }
        .menu-section-title { font-weight: bold; font-size: 0.85em; color: #333; margin-bottom: 6px; border-bottom: 1px solid #eee; padding-bottom: 3px; }
        .menu-section label { display: block; font-size: 0.8em; margin: 4px 0; cursor: pointer; }
        .menu-section input[type="checkbox"] { margin-right: 6px; }
        .menu-section input[type="number"], .menu-section select { width: 100%; padding: 4px; font-size: 0.8em; border: 1px solid #ccc; border-radius: 3px; margin-top: 2px; }
        .menu-section button { width: 100%; padding: 6px; background: #1976D2; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.8em; margin-top: 4px; }
        .menu-section button:hover { background: #1565C0; }
        
        .legend-dot { display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:4px; vertical-align:middle; border:1px solid #222; }
        .legend-item { display:inline-block; white-space:nowrap; margin-right:6px; font-size: 0.75em; }
        
        .channel-filter { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px; }
        .channel-chip { display: inline-block; padding: 3px 8px; font-size: 0.7em; background: #e0e0e0; border: 1px solid #bbb; border-radius: 12px; cursor: pointer; user-select: none; }
        .channel-chip.active { background: #4CAF50; color: white; border-color: #388E3C; }
        .channel-chip:hover { opacity: 0.8; }
    </style>
</head>
<body data-status-refresh="{{ status_refresh }}" data-node-refresh="{{ node_refresh }}" data-default-lat="{{ default_lat }}" data-default-lon="{{ default_lon }}" data-default-zoom="{{ default_zoom }}" data-move-threshold="{{ special_move_threshold }}" data-api-key-required="{{ api_key_required|lower }}" data-api-key="{{ api_key or '' }}" data-is-localhost="{{ is_localhost|lower }}" style="--special-highlight-color: {{ special_highlight_color }};">
    <!-- API Key Entry Modal (for remote/worldwide access) -->
    <div id="api-key-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:10000; align-items:center; justify-content:center;">
        <div style="background:white; padding:30px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.2); max-width:400px; width:90%;">
            <h2 style="margin-top:0; color:#333;">Access Password Required</h2>
            <p style="color:#666; margin:15px 0;">Enter your access password to view the tracker:</p>
            <input type="password" id="api-key-input" placeholder="Enter password..." style="width:100%; padding:10px; font-size:14px; border:1px solid #ccc; border-radius:4px; box-sizing:border-box; margin-bottom:15px;">
            <div style="display:flex; gap:10px;">
                <button id="api-key-submit" style="flex:1; padding:10px; background:#1976D2; color:white; border:none; border-radius:4px; cursor:pointer; font-size:14px;">Sign In</button>
                <button id="api-key-clear" style="flex:1; padding:10px; background:#ccc; color:#333; border:none; border-radius:4px; cursor:pointer; font-size:14px;">Clear Stored</button>
            </div>
            <p style="font-size:12px; color:#999; margin:15px 0 0 0; text-align:center;">Password saved locally until you click "Clear Stored" or change password</p>
        </div>
    </div>
    <div id="menu-modal" onclick="closeMenuOnBackdrop(event)">
        <div id="menu-panel">
            <span id="menu-close" onclick="toggleMenu()">&times;</span>
            <h2 id="menu-title">‚öôÔ∏è Settings & Controls</h2>
            

            
            <div class="menu-section">
                <div class="menu-section-title">Display Options</div>
                <label><input type="checkbox" id="show-all-nodes" checked> Show all nodes</label>
                <label><input type="checkbox" id="toggle-trails" checked> Show position trails</label>
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                    <label for="trail-hours" style="margin:0;">Trail history (hours):</label>
                    <input type="number" id="trail-hours" min="1" max="168" value="{{ special_history_hours | default(24) }}">
                </div>

            </div>
            
            
            <div class="menu-section">
                <div class="menu-section-title">Legend</div>
                <div style="line-height: 1.6;">
                    <span class="legend-item"><span class="legend-dot" style="background:#2196F3"></span>recent</span>
                    <span class="legend-item"><span class="legend-dot" style="background:#FF9800"></span>stale</span>
                    <span class="legend-item"><span class="legend-dot" style="background:#f44336"></span>very stale</span><br>
                    <span class="legend-item"><span class="legend-dot" style="background:#FFD700"></span>special</span>
                    <span class="legend-item"><span class="legend-dot" style="background:#888"></span>special (stale)</span>
                    <span class="legend-item"><span class="legend-dot" style="background:#999"></span>special (no GPS)</span><br>
                    <div style="margin-top: 6px; font-size: 0.85em;">
                        <div style="margin: 2px 0;">üü¢ <span style="color: #4CAF50;">Dashed ring</span> = Movement threshold</div>
                        <div style="margin: 2px 0;">üî¥ <span style="color: #e91e63;">Solid ring</span> = Moved too far</div>
                    </div>
                </div>
            </div>
            
            <div class="menu-section">
                <div style="margin-top: 6px;">
                    <a href="https://github.com/guthip/buoy-tracker" target="_blank">Full API docs</a>
                </div>
            </div>
        </div>
    </div>
    
    <div id="sidebar">
        <div style="padding: 12px 8px 8px 8px; background: #fff; border-bottom: 2px solid #2196F3;">
            <div style="font-size: 1.1em; font-weight: bold; color: #333;">{{ app_title }}</div>
            <div style="font-size: 0.75em; color: #666; margin-top: 2px;">Version {{ app_version }}</div>
        </div>
        <div id="status-bar">
            <div>
                <strong>Status:</strong> <span id="mqtt-status">Loading...</span><br>
                <strong>Nodes:</strong> <span id="node-count">0</span>
            </div>
            <!-- Polling progress bar -->
            <div style="margin-top: 8px; margin-bottom: 16px;">
                <div style="width: 100%; height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden;">
                    <div id="refresh-progress-bar" style="height: 100%; background: linear-gradient(90deg, #2196F3, #1976D2); width: 0%; transition: width 0.1s linear;"></div>
                </div>
            </div>
            <button id="menu-btn" onclick="toggleMenu()" style="padding: 3px 8px; font-size: 0.75em;">‚ò∞</button>
        </div>
        
        <div id="nodes"></div>
    </div>
    <div id="map"></div>

    <script src="static/app.js?v={{ build_id }}"></script>
</body>
</html>
