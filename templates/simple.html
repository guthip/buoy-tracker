<!DOCTYPE html>
<html>
<head>
    <title>{{ app_title }}</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; display: flex; height: 100vh; }
        #map { flex: 1; }
        #sidebar { width: 320px; background: #f5f5f5; overflow-y: auto; padding: 0; }
        .node { padding: 8px; margin: 5px 8px; background: white; border-left: 4px solid #ccc; cursor: pointer; border-radius: 3px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .node.blue { border-left-color: #2196F3; }
        .node.orange { border-left-color: #FF9800; }
        .node.red { border-left-color: #f44336; }
        .node.gray { border-left-color: #9e9e9e; color: #777; }
        .node.special { background-color: var(--special-highlight-color); border-left-width: 6px; }
        .node.moved-alert { background-color: #ffcdd2; }  /* Darker light red background for moved nodes */
        .node-name { font-weight: bold; font-size: 0.95em; }
        .node-info { font-size: 0.8em; color: #666; margin-top: 3px; line-height: 1.4; }
        
        /* Custom tooltip styles for Safari compatibility */
        .tooltip-item { 
            position: relative; 
            display: inline-block;
            cursor: help;
            border-bottom: 1px dotted #999;
        }
        .tooltip-item:hover { 
            border-bottom-color: #666; 
        }
        .tooltip-item .tooltip-balloon {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 0;
            background-color: rgba(0, 0, 0, 0.9);
            color: #fff;
            text-align: left;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            transition: opacity 0.2s, visibility 0.2s;
            pointer-events: none;
        }
        .tooltip-item .tooltip-balloon::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 15px;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.9) transparent transparent transparent;
        }
        .tooltip-item:hover .tooltip-balloon {
            visibility: visible;
            opacity: 1;
        }
        
        .node-extra { font-size: 0.75em; color: #888; margin-top: 2px; padding-top: 3px; border-top: 1px solid #eee; }
        
        #status-bar { padding: 8px 10px; background: #1976D2; color: white; display: flex; justify-content: space-between; align-items: center; }
        #status-bar strong { font-size: 0.9em; }
        #menu-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 4px 12px; cursor: pointer; border-radius: 3px; font-size: 0.85em; }
        #menu-btn:hover { background: rgba(255,255,255,0.3); }
        
        /* Modal popup styles */
        #menu-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        #menu-modal.open { display: flex; align-items: center; justify-content: center; }
        #menu-panel { background: white; border-radius: 8px; padding: 20px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3); position: relative; }
        #menu-close { position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; color: #aaa; cursor: pointer; line-height: 20px; }
        #menu-close:hover { color: #000; }
        #menu-title { font-size: 1.3em; font-weight: bold; color: #1976D2; margin: 0 0 15px 0; padding-bottom: 10px; border-bottom: 2px solid #1976D2; }
        
        .menu-section { margin-bottom: 12px; }
        .menu-section-title { font-weight: bold; font-size: 0.85em; color: #333; margin-bottom: 6px; border-bottom: 1px solid #eee; padding-bottom: 3px; }
        .menu-section label { display: block; font-size: 0.8em; margin: 4px 0; cursor: pointer; }
        .menu-section input[type="checkbox"] { margin-right: 6px; }
        .menu-section input[type="number"], .menu-section select { width: 100%; padding: 4px; font-size: 0.8em; border: 1px solid #ccc; border-radius: 3px; margin-top: 2px; }
        .menu-section button { width: 100%; padding: 6px; background: #1976D2; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.8em; margin-top: 4px; }
        .menu-section button:hover { background: #1565C0; }
        
        .legend-dot { display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:4px; vertical-align:middle; border:1px solid #222; }
        .legend-item { display:inline-block; white-space:nowrap; margin-right:6px; font-size: 0.75em; }
        
        .channel-filter { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px; }
        .channel-chip { display: inline-block; padding: 3px 8px; font-size: 0.7em; background: #e0e0e0; border: 1px solid #bbb; border-radius: 12px; cursor: pointer; user-select: none; }
        .channel-chip.active { background: #4CAF50; color: white; border-color: #388E3C; }
        .channel-chip:hover { opacity: 0.8; }
    </style>
</head>
<body data-status-refresh="{{ status_refresh }}" data-node-refresh="{{ node_refresh }}" data-default-lat="{{ default_lat }}" data-default-lon="{{ default_lon }}" data-default-zoom="{{ default_zoom }}" data-move-threshold="{{ special_move_threshold }}" data-mqtt-channels="{{ mqtt_channels }}" style="--special-highlight-color: {{ special_highlight_color }};">
    <!-- Menu Modal Popup -->
    <div id="menu-modal" onclick="closeMenuOnBackdrop(event)">
        <div id="menu-panel">
            <span id="menu-close" onclick="toggleMenu()">&times;</span>
            <h2 id="menu-title">‚öôÔ∏è Settings & Controls</h2>
            
            <div class="menu-section">
                <div class="menu-section-title">Channel Filter</div>
                <div class="channel-filter" id="channel-filter"></div>
            </div>
            
            <div class="menu-section">
                <div class="menu-section-title">Display Options</div>
                <label><input type="checkbox" id="filter-special-only" checked> Show only special nodes</label>
                <label><input type="checkbox" id="toggle-offline-specials" checked> Show offline special nodes</label>
                <label><input type="checkbox" id="toggle-trails" checked> Show position trails</label>
                <label>Trail history (hours):
                    <input type="number" id="trail-hours" min="1" max="168" value="{{ special_history_hours | default(24) }}">
                </label>
            </div>
            
            <div class="menu-section">
                <div class="menu-section-title">Sorting</div>
                <label>Sort nodes by:
                    <select id="sort-by">
                        <option value="name">Name (A-Z)</option>
                        <option value="seen-newest" selected>Last seen (newest)</option>
                        <option value="seen-oldest">Last seen (oldest)</option>
                    </select>
                </label>
            </div>
            
            <div class="menu-section">
                <div class="menu-section-title">Legend</div>
                <div style="line-height: 1.6;">
                    <span class="legend-item"><span class="legend-dot" style="background:#2196F3"></span>recent</span>
                    <span class="legend-item"><span class="legend-dot" style="background:#FF9800"></span>stale</span>
                    <span class="legend-item"><span class="legend-dot" style="background:#f44336"></span>very stale</span><br>
                    <span class="legend-item"><span class="legend-dot" style="background:#FFD700"></span>special</span>
                    <span class="legend-item"><span class="legend-dot" style="background:#888"></span>special (stale)</span>
                    <span class="legend-item"><span class="legend-dot" style="background:#999"></span>special (no GPS)</span><br>
                    <div style="margin-top: 6px; font-size: 0.85em;">
                        <div style="margin: 2px 0;">üü¢ <span style="color: #4CAF50;">Dashed ring</span> = Movement threshold</div>
                        <div style="margin: 2px 0;">üî¥ <span style="color: #e91e63;">Solid ring</span> = Moved too far</div>
                    </div>
                </div>
            </div>
            
            <div class="menu-section">
                <div class="menu-section-title">Debug</div>
                <button onclick="showRecent()">View Recent MQTT Messages</button>
                <div style="font-size: 0.75em; color: #666; margin-top: 6px;">Move alert threshold: {{ special_move_threshold }}m</div>
            </div>
            
            <div class="menu-section">
                <div class="menu-section-title">Server Control</div>
                <button onclick="reloadConfig()" style="background: #4CAF50;">Reload Configuration</button>
                <button onclick="restartServer()" style="background: #FF9800;">Restart Server</button>
                <div style="font-size: 0.7em; color: #666; margin-top: 4px; line-height: 1.4;">
                    Use "Reload Configuration" after editing tracker.config to update special nodes without restart.
                </div>
            </div>
            
            <div class="menu-section">
                <div class="menu-section-title">API Reference</div>
                <div style="font-size: 0.75em; line-height: 1.6;">
                    <div style="margin: 4px 0;"><strong>Status:</strong></div>
                    <a href="/api/status" target="_blank" style="color: #1976D2; text-decoration: none;">GET /api/status</a> - Connection & node counts<br>
                    <a href="/health" target="_blank" style="color: #1976D2; text-decoration: none;">GET /health</a> - Health check<br>
                    
                    <div style="margin: 8px 0 4px;"><strong>Nodes:</strong></div>
                    <a href="/api/nodes" target="_blank" style="color: #1976D2; text-decoration: none;">GET /api/nodes</a> - All tracked nodes<br>
                    <a href="/api/recent_messages" target="_blank" style="color: #1976D2; text-decoration: none;">GET /api/recent_messages</a> - Raw MQTT msgs<br>
                    
                    <div style="margin: 8px 0 4px;"><strong>Special Nodes:</strong></div>
                    <span style="color: #666;">GET /api/special/history?node_id=&lt;id&gt;</span><br>
                    <span style="color: #666;">GET /api/special/all_history</span><br>
                    <a href="/api/special/packets?limit=10" target="_blank" style="color: #1976D2; text-decoration: none;">GET /api/special/packets</a><br>
                    
                    <div style="margin: 8px 0 4px;"><strong>Server Control:</strong></div>
                    <span style="color: #666;">POST /api/config/reload</span> - Reload config<br>
                    <span style="color: #666;">POST /api/restart</span> - Restart server<br>
                    
                    <div style="margin-top: 6px; font-size: 0.95em;">
                        <a href="https://github.com/yourusername/buoy_tracker#api-reference" target="_blank" style="color: #1976D2;">üìñ Full API Docs</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="sidebar">
        <div style="padding: 12px 8px 8px 8px; background: #fff; border-bottom: 2px solid #2196F3;">
            <div style="font-size: 1.1em; font-weight: bold; color: #333;">{{ app_title }}</div>
            <div style="font-size: 0.75em; color: #666; margin-top: 2px;">Version {{ app_version }}</div>
        </div>
        <div id="status-bar">
            <div>
                <strong>Status:</strong> <span id="mqtt-status">Loading...</span><br>
                <strong>Nodes:</strong> <span id="node-count">0</span>
            </div>
            <button id="menu-btn" onclick="toggleMenu()">‚ò∞ Menu</button>
        </div>
        
        <div id="nodes"></div>
    </div>
    <div id="map"></div>

    <script src="/static/app.js?v={{ build_id }}"></script>
</body>
</html>
